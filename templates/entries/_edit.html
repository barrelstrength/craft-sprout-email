{% extends "sproutemail/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set crumbs = [
	{ label: craft.sproutEmail.name|t, url: url('sproutemail') },
] %}

{% set title = entry is defined and entry.title is not empty ? entry.title : 'Create a new Entry' %}

{% block main %}
	<form method="post" accept-charset="UTF-8" enctype="multipart/form-data" data-saveshortcut data-saveshortcut-redirect="{{ url('sproutemail/entries/edit/{id}') }}" data-confirm-unload>
		<input type="hidden" name="action" value="sproutEmail/entry/saveEntry">
		<input type="hidden" name="redirect" value="sproutemail/entries">

		{% if entryId is defined and entryId %}
		<input type="hidden" name="entryId" value="{{ entryId }}">
		{% endif %}
		<input type="hidden" name="campaignId" value="{{ campaignId }}">

		{% if namespace is not defined %}{% set namespace = 'fields' %}{% endif %}

		<div class="grid first">

			<div class="item" data-position="left" data-min-colspan="2" data-max-colspan="3">
				<div id="fields" class="pane">

					{% include "_includes/tabs" %}
					{% include "sproutemail/entries/_fields" %}

				</div>
			</div>

			<div class="item" data-position="right" data-colspan="1">

				<div class="pane">

					<nav id="tabs" class="tabs">
						<ul>
							<li><a class="tab sel" href="#tab-sproutemail-overview">Overview</a></li>
							<li><a class="tab" href="#tab-sproutemail-sender">Sender</a></li>
							<li><a class="tab" href="#tab-sproutemail-recipients">Recipients</a></li>

							{% if campaign.type == 'notification' %}
							<li><a class="tab" href="#tab-sproutemail-rules">Rules</a></li>
							{% endif %}
						</ul>
					</nav>

					<div>
						<div id="tab-sproutemail-overview">
							{% if shareUrlHtml is defined and shareUrlText is defined %}
							<h3>Preview: <a href="{{ shareUrlHtml|replace({'.html': ''}) }}">HTML</a> | <a href="{{ shareUrlText }}">Text</a></h3>
							{% endif %}

							{{ forms.textField({
								label: "Slug"|t,
								locale: entry.locale,
								id: 'slug',
								name: 'slug',
								value: entry.slug,
								errors: (entry ? entry.getErrors('slug')|merge(entry.getErrors('uri'))),
							}) }}

							{# {% if canPublish or (not isVersion and canDeleteEntry) %} #}

								{% set statusInput %}
									{# {% if canPublish %} #}
										<div class="left">
											{{ forms.lightswitch({
												id: 'enabled',
												name: 'enabled',
												on: entry.enabled
											}) }}
										</div>
									{# {% endif %} #}

									{# {% if not isSingle and not isVersion and canDeleteEntry %} #}
										<div class="right">
											<input type="button" class="btn small formsubmit" value="{{ 'Delete'|t }}" data-action="sproutEmail/entry/deleteEntry" data-confirm="Are you sure you want to delete this Entry and all of it's data?" data-redirect="sproutemail/entries">
										</div>
									{# {% endif %} #}
								{% endset %}

								{{ forms.field({
									label: "Status"|t,
									id: 'enabled'
								}, statusInput) }}
							{# {% endif %} #}

						</div>

						<div id="tab-sproutemail-sender" class="hidden">

							{{ forms.field({
								label: "From Name <span class='info'>The person or business sending the email</span>"|t,
									errors: (entry is defined ? entry.getErrors('fromName') : null),
									required: true,
								}, forms.textField({
									name: 'sproutEmail[fromName]',
									value: (entry.fromName is not empty ? entry.fromName : 'Selvin Ortiz'),
							})) }}

							{{ forms.field({
							    label: "From Email <span class='info'>The email address of the person or business sending the email</span>"|t,
							    required: true,
									errors: (entry is defined ? entry.getErrors('fromEmail') : null),
								}, forms.textField({
									name: 'sproutEmail[fromEmail]',
									value: (entry.fromEmail is not empty ? entry.fromEmail : 'selvin@selv.in'),
							})) }}

							{{ forms.field({
							    label: "Reply To Email <span class='info'>The email address which will be used if any recipients reply to your email</span>"|t,
							    required: true,
									errors: (entry is defined ? entry.getErrors('replyTo') : null),
								}, forms.textField({
									name: 'sproutEmail[replyTo]',
									value: (entry.replyTo is not empty ? entry.replyTo : 'selvin@selv.in'),
							})) }}

						</div>

						<div id="tab-sproutemail-recipients" class="hidden">

							<div style="max-height:300px;overflow-y:auto;" id="recipients">
								{{ craft.sproutemail.getMailer(campaign.mailer).getRecipientListsHtml(recipientLists) }}
							</div>

						</div>

						{% if campaign.type == 'notification' %}
						<div id="tab-sproutemail-rules" class="hidden">

							{% set events = craft.sproutemail.getAvailableEvents() %}

							{{ forms.selectField({
								id: "notificationEvent",
								name: "notificationEvent",
								label: "Trigger On",
								instructions: "The event your notification will trigger on.",
								options: [{label: "Select event...", value: null}]|merge(events),
								value: notificationEvent is defined ? notificationEvent : null,
							}) }}

							{% for id, event in events %}
								{% if event.getId is defined and event.getOptionsHtml is defined %}
									<div class="event-options-block {{ event.getId() }}">
										{% set options = craft.sproutemail.getSelectedOptions(event, campaignId) %}
										{{ event.getOptionsHtml({forms: forms, options: options})|raw }}
									</div>
								{% endif %}
							{% endfor %}
						</div>
						{% endif %}
					</div>

				</div>

				<table class="inputs fullwidth">
					<tr>
						<td class="thin">

							{% if campaign.type == 'notification' %}
							<div class="btngroup submit first">
								<input type="submit" class="btn submit" value="{{ 'Save Notification'|t }}">
							</div>
							{% endif %}

							{% if campaign.type == 'email' %}

							<div class="btngroup submit first">
								<input type="submit" class="btn submit" value="{{ 'Save'|t }}">
								<a class="btn" href="{{ actionUrl('sproutEmail/') }}" title="{{ 'Test and prepare delivery'|t }}" target="_blank">{{ "Test and prepare delivery"|t }}</a>
							</div>

							{% endif %}
						</td>
					</tr>
				</table>

			</div>

		</div>

	</form>
{% endblock %}

{% if not entry.slug %}
	{% includeJs "window.slugGenerator = new Craft.SlugGenerator('#subjectLine', '#slug');" %}
{% endif %}

{# @TODO - need to customize live preview for emails
{% set js %}
    Craft.livePreview = new Craft.LivePreview("http:\/\/craft.dev\/", "en_us");
{% endset %}

{% includeJs js %} #}
