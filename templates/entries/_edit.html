{% extends "sproutemail/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set crumbs = [
	{ label: craft.sproutEmail.name|t, url: url('sproutemail') },
] %}

{% set title = (entry is defined and entry.title is not empty ? entry.title : 'Create a new Entry') %}

{% block main %}
	
	<form method="post" accept-charset="UTF-8" enctype="multipart/form-data" data-saveshortcut data-saveshortcut-redirect="{{ url('sproutemail/entries/edit/{id}') }}" data-confirm-unload>
		<input type="hidden" name="action" value="sproutEmail/entry/saveEntry">
		<input type="hidden" name="redirect" value="sproutemail/entries">
		
		<input type="hidden" name="campaignId" value="{{ campaignId }}">
		<input type="hidden" name="entryId" value="{{ entryId }}">

		{% if namespace is not defined %}{% set namespace = 'fields' %}{% endif %}

		<div class="grid first">

			{# @TODO - add clear messaging at the top about the status of this blast
			{% if entry.enabled %}
			<div class="item" data-colspan="3">
				<div class="pane" style="font-size:14px;">
					<p><strong>Active:</strong> This notification is turned on and delivering.</p>
					<p><strong>Exported:</strong> This campaign was exported to SendGrid on X date.</p>
					<p><strong>Sent:</strong> This campaign was sent via MailGun on X date.</p>
				</div>
			</div>
			{% endif %}
			#}

			<div class="item" data-position="left" data-min-colspan="2" data-max-colspan="3">
				<div id="fields" class="pane">

					{% include "_includes/tabs" %}
					{% include "sproutemail/entries/_fields" %}

				</div>
			</div>

			<div class="item" data-position="right" data-colspan="1">

				<div class="pane">

					<nav id="tabs" class="tabs">
						<ul>
							<li><a class="tab sel" href="#tab-sproutemail-overview">Overview</a></li>
							<li><a class="tab" href="#tab-sproutemail-sender">Sender</a></li>
							<li><a class="tab" href="#tab-sproutemail-recipients">Recipients</a></li>

							{% if campaign.type == 'notification' %}
							<li><a class="tab" href="#tab-sproutemail-rules">Rules</a></li>
							{% endif %}
						</ul>
					</nav>

					<div>
						<div id="tab-sproutemail-overview">
							{% if shareUrlHtml is defined and shareUrlText is defined %}
							<h3>Preview: <a href="{{ shareUrlHtml }}">HTML</a> | <a href="{{ shareUrlText }}">Text</a></h3>
							{% endif %}

							<p>
								<strong>Sender</strong><br/>
								Ben Parizek<br/>
								ben@barrelstrengthdesign.com
							</p>

							<p>
								<strong>Reply To</strong><br/>
								ben@barrelstrengthdesign.com
							</p>

							<strong>Recipents</strong>
							<ul>
								<li>List One</li>
								<li>List Two</li>
							</ul>

							{% if campaign.type == 'email' %}

							{{ forms.textField({
								label: "Slug"|t,
								locale: entry.locale,
								id: 'slug',
								name: 'slug',
								value: entry.slug,
								errors: (entry ? entry.getErrors('slug')|merge(entry.getErrors('uri'))),
							}) }}

							{% endif %}

							{# {% if canPublish or (not isVersion and canDeleteEntry) %} #}

								{% set statusInput %}
									{# {% if canPublish %} #}
										<div class="left">
											{{ forms.lightswitch({
												id: 'enabled',
												name: 'enabled',
												on: entry.enabled
											}) }}
										</div>
									{# {% endif %} #}

									{# {% if not isSingle and not isVersion and canDeleteEntry %} #}
										<div class="right">
											<input type="button" class="btn small formsubmit" value="{{ 'Delete'|t }}" data-action="sproutEmail/entry/deleteEntry" data-confirm="Are you sure you want to delete this Entry and all of it's data?" data-redirect="sproutemail/entries">
										</div>
									{# {% endif %} #}
								{% endset %}

								{{ forms.field({
									label: "Status"|t,
									id: 'enabled'
								}, statusInput) }}
							{# {% endif %} #}

						</div>

						<div id="tab-sproutemail-sender" class="hidden">

						{% if craft.sproutEmail.getGeneralSettingsTemplate(campaign.emailProvider) %}

							<div id="{{ campaign.emailProvider }}-generalsettings-template" class="generalsettings"   >
								{% include "sproutemail/_providers/" ~ campaign.emailProvider ~ "/generalCampaignSettings" %}
							</div>

						{% else %}

							<div id="{{ campaign.emailProvider }}-generalsettings-template"  class="generalsettings"  >
							{% include "sproutemail/_partials/generalCampaignSettings" %}
							</div>

						{% endif %}

						</div>

						<div id="tab-sproutemail-recipients" class="hidden">

							<style type="text/css">
							#recipients label {
								padding-left:2px;
							}
							</style>

							<div style="max-height:300px;overflow-y:auto;" id="recipients">
							{% include "sproutemail/_providers/" ~ campaign.emailProvider ~ "/recipients" %}
							</div>

						</div>

						{% if campaign.type == 'notification' %}
						<div id="tab-sproutemail-rules" class="hidden">

							{% set events = craft.sproutEmail.getNotificationEvents() %}
							
							{% set existingEvent = (campaign is defined and campaign.notificationEvent[0] is defined ? (campaign.notificationEvent[0].registrar == 'craft' ? campaign.notificationEvent[0].event | replace({'.':'---'}) : campaign.notificationEvent[0].id) : null) %}

							{% set notificationEvent = (campaign is defined ? (campaign.getErrors()|length ? campaign.notificationEvent : existingEvent) : null) %}

							{{ forms.selectField({
								label: "When would you like to send this email"|t,
								id: 'notificationEvent',
								name: 'sproutEmail[notificationEvent]',
								instructions: "Select the event on which you would like to send this email."|t,
								options : events,
								value: notificationEvent,
								errors: (campaign is defined ? campaign.getErrors('notificationEvent') : null) 	
							}) }}
							
							{% set eventOptions = craft.sproutEmail.getNotificationEventOptions() %}
							
							{% if eventOptions.system_options is defined %}
								{% for key, val in eventOptions.system_options %}
									{% for key2, val2 in val %}
										<div class="event_options {{ key | replace({'.':'---'}) }}" >
											{% include "sproutemail/settings/notifications/_options/" ~ key ~ "/" ~  val2 %}
										</div>
									{% endfor %}
								{% endfor %}
							{% endif %}
							
							{% if eventOptions.plugin_options is defined %}
								{% for key, val in eventOptions.plugin_options %}
										<div class="event_options {{ key }}" >
											{{ include(template_from_string(val.html))  }}
										</div>
								{% endfor %}	
							{% endif %}

						</div>
						{% endif %}
					</div>

				</div>
				

				<table class="inputs fullwidth">
					<tr>
						<td class="thin">

							{% if campaign.type == 'notification' %}
							<div class="btngroup submit first">
								<input type="submit" class="btn submit" value="{{ 'Save Notification'|t }}">
							</div>
							{% endif %}

							{% if campaign.type == 'email' %}

							<div class="btngroup submit first">
								<input type="submit" class="btn submit" value="{{ 'Save'|t }}">
							</div>

							<div id="view-btns" class="btngroup preview-btns">
								<div class="btn">
									<a href="#" title="{{ 'Test and prepare delivery'|t }}" target="_blank">{{ "Test and prepare delivery"|t }}</a>
								</div>
							</div>

							{% endif %}
						</td>
					</tr>
				</table>

			</div>

		</div>
	
	</form>


<style type="text/css">
	.preview-btns a {
		color:inherit;
		text-decoration: none;
	}
</style>
{% endblock %}


{% if not entry.slug %}
	{% includeJs "window.slugGenerator = new Craft.SlugGenerator('#title', '#slug');" %}
{% endif %}

{# @TODO - need to customize live preview for emails
{% set js %}
    Craft.livePreview = new Craft.LivePreview("http:\/\/craft.dev\/", "en_us");
{% endset %}

{% includeJs js %} #}
