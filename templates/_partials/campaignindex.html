{% if loop.first %}

{% if craft.request.getSegment(2) == "" %}
<h3>{{ "Campaigns"|t }}</h3>
{% endif %}

<table id="campaigns" class="data fullwidth">
	<thead>
		<th width="70%"></th>
		<th width="15%"></th>
		<th width="15%"></th>
	</thead>
{% endif %}

	<tr data-id="{{ campaign.id }}" data-entry-id="{{ campaign.entryId }}" data-name="{{ campaign.name|t }}">
		<td>
			{% set section = craft.sections.getSectionById(campaign.sectionId) %}
			<a href="{{ url('entries/' ~ section.handle ~ '/') }}/{{ campaign.entryId }}">{{ campaign.title ? campaign.title : 'New Campaign' }}</a><br/>
			<span style="color: #999;text-transform:uppercase;font-size:.8em">{{ campaign.name }} <span style="color:#121212;">/</span> 

    			{% set entries = craft.entries.id(campaign.entryId) %}
                
                {% for entry in entries %}
    
                    {{ entry.dateCreated|date('F d, Y') }}
                
                {% endfor %}

            </span>
		</td>
		
		{% if campaign.sectionId and campaign.entryId and campaign.textTemplate and campaign.emailProvider %}
		<td>		
			<a href="{{ siteUrl }}{{campaign.htmlTemplate|replace({'.html': ''}) }}?entryId={{campaign.entryId}}" target="_blank">HTML</a> 
			/ 
			<a href="{{ siteUrl }}{{campaign.textTemplate }}?entryId={{campaign.entryId}}" target="_blank">Text</a> 
		</td>
		<td>
            {% if campaign.emailProvider == 'SproutEmail' %}
                 <a href="#" class="export btn small" >
                     Send Email Blast
                 </a>
            {% elseif campaign.emailProvider == 'CopyPaste' %}
                 <a href="#" data-format="html" class="copy btn small" >
                     Display Source
                 </a>
            {% else %}
                 <a href="#" class="export btn small" >
                     Export to {{ campaign.emailProvider }} 
                 </a>
            {% endif %}
		</td>
		{% else %}
		<td colspan="2">
		<i>This Email Blast is incomplete.</i>
		</td>
		{% endif %}
	</tr>

{% if loop.last %}
</table>
<br/>
<br/>

{% set js %}
	new Craft.AdminTable({
		tableSelector: '#campaigns',
		noObjectsSelector: '#nocampaigns',
		deleteAction: 'SproutEmail/campaigns/delete'
	});
	
	jQuery(document).ready(function(){

		jQuery('.export').click(function(){
		    var tr = jQuery(this).closest('tr');
			
			var query = 'entryId='+tr.data('entry-id')
			            +'&campaignId='+tr.data('id')
                        +'&action=SproutEmail/campaigns/export';

			$.post('{{ url('SproutEmail/campaigns/export') }}',query, function(data){
			    alert(data);
			})
            return false;
		})

		jQuery('.copy').click(function(){

		    var tr      = jQuery(this).closest('tr');
			
			var query = 'entryId='+tr.data('entry-id')
			            +'&campaignId='+tr.data('id')
                        +'&action=SproutEmail/campaigns/export';

			jQuery.post('{{ url('SproutEmail/campaigns/export') }}',query, function(data){
                var myModal = new Garnish.Modal($('<div class="modal" style="padding: 40px;">'+
                                                  '<h1>Source</h1>'+
                                                  '<h2>HTML Source</h2><textarea style="width:100%;height:35%">'+data.html+'</textarea>'+
                                                  '<h2>Plain Text Source</h2><textarea style="width:100%;height:35%">'+data.text+'</textarea>'+
                                                  '</div>'));
			}, "json");
            return false;
		})

	})
{% endset %}
{% includeJs js %}

{% endif %}